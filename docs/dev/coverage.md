# Developer Coverage Overview

## Building

The implementation of coverage starts with the "doCoverage" flag on
the builder in `comp-builder.nix`. The doCoverage flag enables and
disables the Cabal coverage flag and copies any generated coverage
data to "$out/share/hpc".

There also exists a `covered` attribute on each component, it takes
the existing derivation for that component and modifies it to have
coverage enabled.

## Mix and tix files

The coverage information for any derivation consists of "mix" and
"tix" files.

Mix files record static information about a source file and are
generated at build time. They primarily contain a path to the source
file and information about expressions and regions of the source file,
which are later referenced by tix files.

Tix files contain dynamic information about a test run, recording when
a portion of a source file is touched by a test. These are generated
when the test is run.

## Coverage reports

### Package reports

The coverage information generated will look something like this:

```bash
/nix/store/...-my-project-0.1.0.0-coverage-report/
└── share
    └── hpc
        ├── mix
        │   ├── my-library-0.1.0.0
        │   │   └── my-library-0.1.0.0-ERSaOroBZhe9awsoBkhmcV
        │   │       ├── My.Lib.Config.mix
        │   │       ├── My.Lib.Types.mix
        │   │       └── My.Lib.Util.mix
        │   └── my-test-1
        │       ├── Spec.mix
        │       └── Main.mix
        ├── tix
        │   ├── my-library-0.1.0.0
        │   │   └── my-library-0.1.0.0.tix
        │   └── my-test-1
        │       └── my-test-1.tix
        └── html
            ├── my-library-0.1.0.0
            │   ├── my-library-0.1.0.0-ERSaOroBZhe9awsoBkhmcV
            │   │   ├── My.Lib.Config.hs.html
            │   │   ├── My.Lib.Types.hs.html
            │   │   └── My.Lib.Util.hs.html
            │   ├── hpc_index_alt.html
            │   ├── hpc_index_exp.html
            │   ├── hpc_index_fun.html
            │   └── hpc_index.html
            └── my-test-1
                ├── my-library-0.1.0.0-ERSaOroBZhe9awsoBkhmcV
                │   ├── My.Lib.Config.hs.html
                │   ├── My.Lib.Types.hs.html
                │   └── My.Lib.Util.hs.html
                ├── hpc_index_alt.html
                ├── hpc_index_exp.html
                ├── hpc_index_fun.html
                └── hpc_index.html
```

- The mix files are copied verbatim from the builds with coverage.
- The tix files for each test are copied from the check run verbatim.
- The tix files for each library are generated by summing the tix
  files for each test, but excluding any test modules.
  - Test modules are determined by inspecting the plan for the project
    (i.e. for the project "my-project" and test-suite "my-test-1", the
    test modules are read from:
    `my-project.project.pkg-set.config.packages.my-project.components.tests.my-test-1.modules`)
- The hpc reports for each component are generated from their
  respective tix files.
  - `html/my-library-0.1.0.0/hpc_index.html` contains coverage
    information for the library, excluding any test modules.
  - `html/my-test-1/hpc_index.html` contains the coverage information
    that the test contributes to the library, excluding any test modules.
    - The library might have 100% coverage, 50% generated by test-1
      and 50% generated by test-2. The HTML reports for each test will
      only show 50% coverage, but the library will show 100% coverage.

### Project-wide reports

The coverage information for an entire project will look something
like this:

```bash
/nix/store/...-coverage-report
└── share
    └── hpc
        ├── mix
        │   ├── my-library-0.1.0.0
        │   │   └── my-library-0.1.0.0-ERSaOroBZhe9awsoBkhmcV
        │   │       ├── My.Lib.Config.mix
        │   │       ├── My.Lib.Types.mix
        │   │       └── My.Lib.Util.mix
        │   ├── my-test-1
        │   │   ├── Spec.mix
        │   │   └── Main.mix
        │   ├── other-library-0.1.0.0
        │   │   └── other-library-0.1.0.0-48EVZBwW9Kj29VTaRMhBDf
        │   │       ├── Other.Lib.A.mix
        │   │       └── Other.Lib.B.mix
        │   └── other-test-1
        │       ├── Spec.mix
        │       └── Main.mix
        ├── tix
        │   ├── all
        │   │   └── all.tix
        │   ├── my-library-0.1.0.0
        │   │   └── my-library-0.1.0.0.tix
        │   ├── my-test-1
        │   │   └── my-test-1.tix
        │   ├── other-library-0.1.0.0
        │   │   └── other-library-0.1.0.0.tix
        │   └── other-test-1 
        │       └── other-test-1.tix
        └── html
            ├── my-library-0.1.0.0
            │   ├── my-library-0.1.0.0-ERSaOroBZhe9awsoBkhmcV
            │   │   ├── My.Lib.Config.hs.html
            │   │   ├── My.Lib.Types.hs.html
            │   │   └── My.Lib.Util.hs.html
            │   ├── hpc_index_alt.html
            │   ├── hpc_index_exp.html
            │   ├── hpc_index_fun.html
            │   └── hpc_index.html
            ├── my-test-1
            │   ├── my-library-0.1.0.0-ERSaOroBZhe9awsoBkhmcV
            │   │   ├── My.Lib.Config.hs.html
            │   │   ├── My.Lib.Types.hs.html
            │   │   └── My.Lib.Util.hs.html
            │   ├── hpc_index_alt.html
            │   ├── hpc_index_exp.html
            │   ├── hpc_index_fun.html
            │   └── hpc_index.html
            ├── other-libray-0.1.0.0
            │   ├── other-library-0.1.0.0-48EVZBwW9Kj29VTaRMhBDf
            │   │   ├── Other.Lib.A.hs.html
            │   │   └── Other.Lib.B.hs.html
            │   ├── hpc_index_alt.html
            │   ├── hpc_index_exp.html
            │   ├── hpc_index_fun.html
            │   └── hpc_index.html
            ├── other-test-1
            │   ├── other-library-0.1.0.0-48EVZBwW9Kj29VTaRMhBDf
            │   │   ├── Other.Lib.A.hs.html
            │   │   └── Other.Lib.B.hs.html
            │   ├── hpc_index_alt.html
            │   ├── hpc_index_exp.html
            │   ├── hpc_index_fun.html
            │   └── hpc_index.html
            └── index.html
```

All of the coverage information is copied verbatim from the coverage
reports for each of the constituent packages. A few additions are
made:
  - `tix/all/all.tix` is generated from the union of all the library
    tix files.
    - We use this file when generating coverage reports for
      "coveralls.io".
  - An index page (`html/index.html`) is generated which links to the
    HTML coverage reports of the constituent packages.
